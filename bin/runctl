#!/bin/bash

#------------------------------------------------------------------------------
# Global constants:
#------------------------------------------------------------------------------

readonly DOCKER=`which docker`
readonly IPCMD=`which ip`

#------------------------------------------------------------------------------
# Source the configuration:
#------------------------------------------------------------------------------

[ -f /etc/booddies/gito.conf ] && . /etc/booddies/gito.conf || exit 99

#------------------------------------------------------------------------------
# To be called by ExecStartPre:
#------------------------------------------------------------------------------

function run_pre {
  $DOCKER kill $ID || exit 1
  $DOCKER rm $ID || exit 2
  $IPCMD link del veth-${ID} &> /dev/null
  $DOCKER pull $IMAGE && return 0
}

#------------------------------------------------------------------------------
# To be called by ExecStart:
#------------------------------------------------------------------------------

function run_start {
  exec $DOCKER run -t \
  --volume   /data/gito/repos:/home/git/repositories \
  --volume   /home/marc/.ssh/gitolite.key:/home/git/.ssh/id_rsa \
  --hostname $HOSTNAME \
  --name     $ID \
  --net      none \
  --env      WAIT_NETWORK=true \
  --env      TRUST_HOSTS=github.com \
  $IMAGE
}

#------------------------------------------------------------------------------
# To be called by ExecStartPost:
#------------------------------------------------------------------------------

function run_post {

  # Wait for the container:
  RETRIES=10; while [ $RETRIES -gt 0 ]; do
    PID=$($DOCKER inspect --format='{{ .State.Pid }}' \
    $ID 2> /dev/null | grep -oE "^[0-9]+") || PID=0
    [ $PID -gt 0 ] && break
    sleep 1; RETRIES=$((RETRIES - 1))
  done

  # Setup the environment:
  [ $RETRIES -eq 0 ] && exit 1
  [ ! -d /var/run/netns ] && mkdir -p /var/run/netns
  ln -fs /proc/$PID/ns/net /var/run/netns/$PID || exit 2

  # Host-side network:
  $IPCMD link add ${ID}-int type veth peer name veth-${ID} || exit 3
  $IPCMD link set veth-${ID} master br0 || exit 4
  $IPCMD link set veth-${ID} up || exit 5
  $IPCMD link set netns $PID dev ${ID}-int || exit 6

  # Container-side network:
  $IPCMD netns exec $PID ip link set ${ID}-int name eth1 || exit 7
  [ -f /run/dhcpcd-eth1* ] && rm -f /run/dhcpcd-eth1*
  $IPCMD netns exec $PID dhcpcd -4 -A -c /bin/true -q eth1 -h $ID || exit 8
}

#------------------------------------------------------------------------------
# To be called by ExecStop:
#------------------------------------------------------------------------------

function run_stop {
  $DOCKER stop $ID || exit 1
  $IPCMD link del veth-${ID} &> /dev/null || exit 2
  return 0
}

#------------------------------------------------------------------------------
# Entry point:
#------------------------------------------------------------------------------

case $1 in pre|start|post|stop) run_$1 ;; esac
